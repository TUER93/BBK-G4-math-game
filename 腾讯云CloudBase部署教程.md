# 腾讯云 CloudBase 部署教程 - BBK数学答题王

## 📋 准备工作

### 需要的材料：
- ✅ 腾讯云账号（可用微信/QQ登录）
- ✅ 实名认证（必须）
- ✅ 学生认证（可选，有优惠）

---

## 🚀 详细部署步骤

### 第一步：注册并认证腾讯云账号

#### 1.1 注册账号
1. 访问：https://cloud.tencent.com
2. 点击右上角 **"免费注册"**
3. 可选择：
   - 微信扫码注册（推荐）
   - QQ 登录
   - 邮箱注册
4. 完成注册

#### 1.2 实名认证（必须）
1. 登录后，进入控制台
2. 系统会提示进行实名认证
3. 选择 **"个人认证"**
4. 填写身份信息
5. 提交审核（通常几分钟内通过）

#### 1.3 学生认证（可选，有优惠）
1. 访问：https://cloud.tencent.com/act/campus
2. 点击 **"学生认证"**
3. 上传学生证照片
4. 审核通过后可享受学生优惠套餐

---

### 第二步：开通云开发 CloudBase

#### 2.1 进入云开发控制台
1. 访问：https://console.cloud.tencent.com/tcb
2. 如果是第一次使用，会提示开通服务
3. 点击 **"同意协议并开通"**

#### 2.2 创建环境
1. 点击 **"新建"** 或 **"新建环境"**
2. 填写配置：
   - **环境名称**：`bbk-game`（英文）
   - **环境 ID**：自动生成或自定义
   - **计费方式**：选择 **"按量付费"**（有免费额度）
   - **地域**：选择 **"上海"** 或离你最近的地域
3. 点击 **"立即开通"**
4. 等待环境初始化（约 1-2 分钟）

#### 2.3 免费额度说明
腾讯云开发提供免费额度：
- ✅ 云函数调用：100万次/月
- ✅ 云存储：5GB
- ✅ CDN 流量：5GB/月
- ✅ 数据库读写：5万次/月

**足够小型项目使用！**

---

### 第三步：准备项目代码

#### 3.1 修改项目结构

由于 CloudBase 的云托管需要 Docker，我们使用 **云函数** 方式部署更简单。

需要创建云函数入口文件：

**在项目根目录创建 `cloudbaserc.json`：**
```json
{
  "envId": "你的环境ID",
  "functionRoot": "./functions",
  "$schema": "https://framework-1258016615.tcloudbaseapp.com/schema/latest.json",
  "framework": {
    "name": "bbk-game",
    "plugins": {
      "node": {
        "use": "@cloudbase/framework-plugin-node",
        "inputs": {
          "entry": "server.js",
          "name": "bbk-game",
          "path": "/"
        }
      }
    }
  }
}
```

---

### 第四步：部署到云托管（最简单方法）

腾讯云开发提供两种部署方式：
1. **云托管**（推荐）- 支持完整 Node.js 应用
2. **云函数** - 适合简单 API

**我们使用云托管方式**，已为你创建好配置文件。

#### 4.1 开通云托管服务

1. 在云开发控制台左侧菜单找到 **"云托管"**
2. 点击 **"开通"**
3. 选择 **"按量付费"**
4. 点击 **"确认开通"**
5. 等待服务开通完成

#### 4.2 创建服务

1. 点击 **"新建服务"**
2. 填写配置：
   - **服务名称**：`bbk-game`
   - **镜像仓库**：自动创建
   - **备注**：BBK数学答题王
3. 点击 **"确认"**

#### 4.3 部署方式选择

**方式A：使用网页控制台上传（推荐，最简单）**

1. 在服务详情页，点击 **"新建版本"**
2. 选择 **"本地代码"**
3. 上传方式：
   - 压缩项目文件夹为 `.zip` 文件（不要包含 `node_modules`）
   - 点击上传
4. 配置参数：
   - **监听端口**：`80`
   - **流水线**：选择 **"Node.js 16"**
   - **副本个数**：1
   - **CPU**：0.25核（免费额度）
   - **内存**：0.5G（免费额度）
5. 高级设置：
   - **环境变量**：不需要额外配置
   - **持久化存储**：稍后配置
6. 点击 **"开始部署"**
7. 等待部署完成（3-5分钟）

**方式B：使用 CloudBase CLI（需要命令行）**

如果你的系统支持命令行，可以使用 CLI：

```bash
# 安装 CloudBase CLI
npm install -g @cloudbase/cli

# 登录
tcb login

# 初始化（在项目目录）
tcb init

# 部署
tcb hosting deploy
```

---

### 第五步：配置持久化存储（重要！）

由于云托管容器重启会丢失数据，需要配置持久化存储：

#### 5.1 开通文件存储 CFS

1. 在云托管服务页面，点击 **"存储"** 标签
2. 点击 **"绑定文件系统"**
3. 如果没有，点击 **"新建文件系统"**：
   - **名称**：`bbk-data`
   - **可用区**：选择与云托管相同的区域
   - **存储类型**：通用标准型
   - **容量**：10GB（够用）
4. 点击 **"确认"**
5. 挂载配置：
   - **挂载点路径**：`/app/data`
   - 勾选自动创建目录
6. 点击 **"确认"**

#### 5.2 修改数据存储路径

需要修改代码，让数据文件保存到持久化目录。

---

### 第六步：获取访问域名

#### 6.1 查看默认域名

1. 在服务详情页，点击 **"访问配置"** 标签
2. 可以看到系统分配的默认域名：
   - 格式：`https://bbk-game-xxxxx.sh.run.tcloudbase.com`
3. 复制域名，在浏览器访问测试

#### 6.2 绑定自定义域名（可选）

如果你有自己的域名：

1. 点击 **"添加域名"**
2. 输入你的域名：`game.yourdomain.com`
3. 配置 DNS 解析（按照提示操作）
4. 等待 SSL 证书自动签发
5. 完成绑定

---

### 第七步：配置数据持久化（代码修改）

为了确保数据保存到持久化存储，我需要修改 `server.js`。

---

## 📝 打包项目文件

在上传到腾讯云之前，需要打包项目：

### 需要打包的文件：
```
✅ server.js
✅ app.js
✅ audio-manager.js
✅ index.html
✅ styles.css
✅ admin.html
✅ admin.js
✅ admin-style.css
✅ package.json
✅ package-lock.json
✅ questions.json
✅ students.json
✅ data.json
✅ Dockerfile
✅ .dockerignore
✅ cloudbaserc.json
✅ audio/ 文件夹（所有音频文件）
✅ 所有 .md 和 .txt 文档
```

### ❌ 不要打包：
```
❌ node_modules/ 文件夹
❌ .git/ 文件夹
```

### 打包步骤：
1. 选中上述所有文件和文件夹
2. 右键 → 发送到 → 压缩(zipped)文件夹
3. 命名为：`bbk-game.zip`
4. 这个文件就可以上传到腾讯云了

---

## 💰 费用说明

### 免费额度（每月）：
- ✅ 云托管 CPU：1000 核时/月
- ✅ 内存：2000 GiB时/月  
- ✅ 流量：1 GB/月
- ✅ 构建时长：200 分钟/月

### 预估费用（超出免费额度后）：
- 小型项目（100人以内）：**完全免费**
- 中型项目（1000人）：约 5-10 元/月
- 大型项目（10000人）：约 50-100 元/月

**学生认证后有更多优惠！**

---

## 🔍 部署后检查

部署成功后，访问域名检查：

1. ✅ 首页能正常显示
2. ✅ 登录功能正常
3. ✅ 能加载题目
4. ✅ 能提交答案
5. ✅ 音效能播放
6. ✅ 管理后台可访问（`/admin.html`）
7. ✅ 数据能保存（刷新后不丢失）

---

## 🆘 常见问题

### Q1: 部署失败，提示 "构建超时"
**A**: 
- 检查是否上传了 `node_modules`（不应该上传）
- 确保 `package.json` 正确
- 尝试增加构建超时时间

### Q2: 访问域名显示 502/504 错误
**A**:
- 检查监听端口是否设置为 `80`
- 查看服务日志，找到错误信息
- 确保 `server.js` 中使用 `process.env.PORT`

### Q3: 数据保存后丢失
**A**:
- 确认已配置文件存储 CFS
- 检查挂载路径是否正确
- 确保数据文件保存在挂载目录下

### Q4: 音频文件无法播放
**A**:
- 确认 `audio` 文件夹已上传
- 检查文件路径是否正确
- 查看浏览器控制台错误信息

### Q5: 超出免费额度怎么办？
**A**:
- 设置费用告警
- 优化资源配置（降低副本数）
- 使用按量付费，流量不大不会超

---

## 📊 监控和管理

### 查看服务状态：
1. 进入云托管控制台
2. 查看服务监控：
   - CPU 使用率
   - 内存使用率
   - 请求数
   - 错误率

### 查看日志：
1. 点击 **"日志"** 标签
2. 实时查看应用日志
3. 搜索错误信息

### 扩缩容：
1. 点击 **"版本管理"**
2. 调整副本数量
3. 调整 CPU/内存配置

---

## 🎯 优化建议

### 1. 使用 CDN 加速静态资源
1. 开通云开发静态托管
2. 上传静态文件（HTML、CSS、JS、图片、音频）
3. 获得 CDN 加速地址

### 2. 使用云数据库存储数据
1. 开通云数据库
2. 替代文件存储
3. 性能更好，更稳定

### 3. 配置监控告警
1. 设置 CPU/内存告警
2. 设置费用告警
3. 及时发现问题

---

## 📞 需要帮助？

如果在部署过程中遇到问题：

1. 查看腾讯云官方文档：https://cloud.tencent.com/document/product/876
2. 查看服务日志找到错误原因
3. 告诉我具体的错误信息，我会帮你解决

---

## 🚀 快速开始总结

1. **注册腾讯云** → 实名认证
2. **开通云开发** → 创建环境
3. **开通云托管** → 创建服务  
4. **打包项目** → 上传部署
5. **配置存储** → 持久化数据
6. **获取域名** → 访问测试

**预计用时：20-30 分钟**

祝你部署顺利！🎉
